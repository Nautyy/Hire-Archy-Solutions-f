<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Candidate Forms</title>
    <link href="css/style.css" rel="stylesheet">
    <link rel="shortcut icon" href="images/favicon-32x32.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css">
    <style>
        .navbar-brand img {
            height: 30px;
            width: auto;
        }

        body {
            margin-top: 10rem;
        }
    </style>
</head>

<body>

    <header class="header_wrap">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <nav class="mega_nav navbar navbar-expand-md p-0 justify-content-between navbar-click">
                        <div class="nav_left" style="">
                            <a class="navbar-brand " id="candidate-logo"><img src="images/logo.png"
                                    class="cursor-pointer"></a>

                        </div>

                    </nav>
                </div>
            </div>
        </div>
    </header>
    <section class="bg-gray-50 dark:bg-gray-900 p-3 sm:p-5">
        <div class="mx-auto max-w-screen-xl px-4 lg:px-12">
            <!-- Start coding here -->
            <div class="bg-blue-800 dark:bg-gray-800 relative shadow-md sm:rounded-lg overflow-hidden">
                <div
                    class="flex flex-col md:flex-row items-center justify-center space-y-3 md:space-y-0 md:space-x-4 p-4">

                    <div
                        class="w-full md:w-auto flex flex-col md:flex-row space-y-2 md:space-y-0 items-stretch md:items-center justify-center md:space-x-3 flex-shrink-0">


                        <h1 class="text-center font-bold text-3xl mt-4 text-white">Candidate Forms</h1>


                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                            <tr>
                                <th scope="col" class="px-4 py-3">Name</th>
                                <th scope="col" class="px-4 py-3">College</th>
                                <th scope="col" class="px-4 py-3">Email</th>
                                <th scope="col" class="px-4 py-3">Address</th>
                                <th scope="col" class="px-4 py-3">DOB</th>
                                <th scope="col" class="px-4 py-3">Resume</th>

                            </tr>
                        </thead>
                        <tbody id="candidate-us-forms-tbody">


                        </tbody>
                    </table>
                </div>
                <table class="hidden" id="excel-table">
                    <thead>
                        <tr>
                            <th scope="col" class="px-4 py-3">Name</th>
                            <th scope="col" class="px-4 py-3">College</th>
                            <th scope="col" class="px-4 py-3">Email</th>
                            <th scope="col" class="px-4 py-3">Address</th>
                            <th scope="col" class="px-4 py-3">DOB</th>
                            <th scope="col" class="px-4 py-3">Resume</th>

                        </tr>
                    </thead>
                    <tbody id="excel-tbody">

                    </tbody>
                </table>
                <nav class="flex flex-col md:flex-row justify-between items-start md:items-center space-y-3 md:space-y-0 p-4"
                    aria-label="Table navigation">
                    <span class="text-sm font-normal text-white dark:text-gray-400">
                        Showing
                        <span class="font-semibold text-white dark:text-white" id="curr-rows"><span
                                id="start-row"></span>-<span id="end-row"></span></span>
                        of
                        <span class="font-semibold text-white dark:text-white" id="total-rows">1</span>
                    </span>
                    <button onclick="exportTableToExcel('excel-table', 'candidateForms')"
                        class="bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-lg">Download Excel</button>
                    <ul class="inline-flex items-stretch -space-x-px">
                        <li>
                            <a href="#" id="prev-page"
                                class="flex items-center justify-center h-full py-1.5 px-3 ml-0 text-gray-500 bg-white rounded-l-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                                <span class="sr-only">Previous</span>
                                <svg class="w-5 h-5" aria-hidden="true" fill="currentColor" viewbox="0 0 20 20"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                        d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </a>
                        </li>
                        <li>
                            <a href="#" id="current-page"
                                class="bg-white flex items-center justify-center text-sm z-10 py-2 px-3 leading-tight text-primary-600 bg-primary-50 border border-primary-300 hover:bg-primary-100 hover:text-primary-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white">1</a>
                        </li>

                        <li>
                            <a href="#" id="next-page"
                                class="flex items-center justify-center h-full py-1.5 px-3 leading-tight text-gray-500 bg-white rounded-r-lg border border-gray-300 hover:bg-gray-100 hover:text-gray-700 dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white">
                                <span class="sr-only">Next</span>
                                <svg class="w-5 h-5" aria-hidden="true" fill="currentColor" viewbox="0 0 20 20"
                                    xmlns="http://www.w3.org/2000/svg">
                                    <path fill-rule="evenodd"
                                        d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                                        clip-rule="evenodd" />
                                </svg>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </section>

    <script>
        let currPage = document.getElementById('current-page')
        let page = currPage.textContent || '1';

        document.getElementById('candidate-logo').addEventListener('click', (e) => {
            window.history.back();
        })

        document.getElementById('prev-page').addEventListener('click', (e) => {
            let page = currPage.textContent || '1';
            e.preventDefault();
            if (page === '1') return;
            page = parseInt(page) - 1;
            fetchCandidateUsForms(page.toString());

            currPage.textContent = page.toString();
        });

        document.getElementById('next-page').addEventListener('click', (e) => {
            e.preventDefault();
            let totalRows = document.getElementById('total-rows').textContent;
            let page = currPage.textContent || '1';

            if (parseInt(page) * 10 >= parseInt(totalRows)) return;
            page = parseInt(page) + 1;
            fetchCandidateUsForms(page.toString());

            currPage.textContent = page.toString();
        });

        function fetchCandidateUsForms(page = '1') {

            fetch(`http://localhost:7777/api/candidate?page=${page}`, {
                headers: {
                    "Authorization": "Bearer " + localStorage.getItem('token'),
                }
            })
                .then((data) => data.json())
                .then((candidateForms) => {
                    if (candidateForms.status === "error") {
                        throw new Error(candidateForms.message);
                        return;
                    }
                    const tbody = document.getElementById('candidate-us-forms-tbody');
                    tbody.innerHTML = '';
                    if (candidateForms.data.forms.length === 0) {
                        tbody.innerHTML = `
                        <tr class="border-b dark:border-gray-700">
                            <td colspan="6" class="px-4 py-3 text-center bg-white">No candidate forms found</td>
                        </tr>
                        `;
                        return;
                    }
                    candidateForms.data.forms.forEach((form, idx) => {
                        const tr = document.createElement('tr');
                        if (idx % 2 === 0) tr.classList.add('bg-purple-50');
                        else tr.classList.add('bg-purple-200');
                        tr.innerHTML = `
                    <tr class="border-b dark:border-gray-700">
                                        <th scope="row"
                                            class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap dark:text-white">${(form.firstName + " " + form.lastName).replace(/~+$/, '')}</th>
                                        <td class="px-4 py-3">${form.college}</td>
                                        <td class="px-4 py-3">${form.email}</td>
                                        <td class="px-4 py-3">${form.state}, ${form.city}</td>
                                        <td class="px-4 py-3">${new Date(form.dob).toLocaleDateString('en-GB', {
                            day: 'numeric', month: 'short', year: 'numeric'
                        }).replace(/ /g, ' ')}</td>
                                        <td class="px-4 py-3 flex items-center justify-end">
                                           
                                            ${form.resume ? `<a href="${form.resume}" class="text-blue-500 hover:underline" target='_blank'>View</a>` : 'N/A'}
                                        </td>
                                    </tr>
                    `;
                        tbody.appendChild(tr);
                    });
                    let totalRows = candidateForms.data.totalRows;
                    document.getElementById('total-rows').textContent = totalRows;
                    document.getElementById('start-row').textContent = (parseInt(page) - 1) * 10 + 1;
                    document.getElementById('end-row').textContent = Math.min(totalRows, parseInt(page) * 10);
                }).catch((err) => {
                    const tbody = document.getElementById('candidate-us-forms-tbody');
                    const error = err.toString();

                    tbody.innerHTML = '';
                    if (error === "Error: Error while verifying token of superAdmin") {
                        tbody.innerHTML = `
                        <tr class="border-b dark:border-gray-700">
                            <td colspan="6" class="px-4 py-3 text-center bg-white">Session expired. Please login again
                                </td>
                        </tr>
                        `;
                    } else {
                        tbody.innerHTML = `
                        <tr class="border-b dark:border-gray-700">
                            <td colspan="6" class="px-4 py-3 text-center bg-white">${error}. Try logging in again.</td>
                        </tr>
                        `;
                    }
                })
        }

        async function exportTableToExcel(tableID, filename = '') {
            const data = await fetch(`http://localhost:7777/api/candidate/allForms`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            });
            const contactUsForms = await data.json();
            const tbody = document.getElementById('excel-tbody');
            tbody.innerHTML = '';
            contactUsForms.data.forEach((form, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <tr class="border-b dark:border-gray-700">
                                        <th scope="row"
                                            class="px-4 py-3 font-medium text-gray-900 whitespace-nowrap dark:text-white">${(form.firstName + " " + form.lastName).replace(/~+$/, '')}</th>
                                        <td class="px-4 py-3">${form.college}</td>
                                        <td class="px-4 py-3">${form.email}</td>
                                        <td class="px-4 py-3">${form.state}, ${form.city}</td>
                                        <td class="px-4 py-3">${new Date(form.dob).toLocaleDateString('en-GB', {
                    day: 'numeric', month: 'short', year: 'numeric'
                }).replace(/ /g, ' ')}</td>
                                        <td class="px-4 py-3 flex items-center justify-end">
                                          ${form.resume} 
                                        </td>
                                    </tr>
                    `;
                tbody.appendChild(tr);
            });

            var downloadLink;
            var dataType = 'application/vnd.ms-excel';
            var tableSelect = document.getElementById(tableID);
            var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

            // Specify file name
            filename = filename ? filename + '.xls' : 'excel_data.xls';

            // Create download link element
            downloadLink = document.createElement("a");

            document.body.appendChild(downloadLink);

            if (navigator.msSaveOrOpenBlob) {
                var blob = new Blob(['\ufeff', tableHTML], {
                    type: dataType
                });
                navigator.msSaveOrOpenBlob(blob, filename);
            } else {
                // Create a link to the file
                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;

                // Setting the file name
                downloadLink.download = filename;

                //triggering the function
                downloadLink.click();
            }
        }


        if (page === '1') fetchCandidateUsForms();
    </script>
</body>

</html>